# 项目需求文档

## 一. 项目背景
    在游戏活动中，经常出现参与者放鸽子的情况，导致活动无法顺利进行。为了解决这一问题，我们决定开发一款微信小程序，通过收取押金并记录打卡的方式来管理参与者的出勤情况。如果参与者未在规定时间内打卡，押金将被扣除并均分给其他打卡的参与者。整个小程序需要用户登录后才能使用，未登录时仅显示底部的个人中心。

## 二. 项目页面
    1. **打卡列表**
        - 显示用户参与的所有打卡活动列表。
        - 列表上显示活动时间、参与人数、实到人数、未到人数、用户是否参与、是否已开启预约。
        - 如果是预约活动，则显示预约时间范围。

    2. **预约详情**
        - 点击列表中的活动信息，如果状态为开启预约，跳转至预约详情页面。
        - 显示活动名称、活动信息、活动时间、活动地点、是否需要人脸识别、是否需要拍照、是否需要保证金、保证金金额、预约时间范围、指定活动参与者的头像。
        - 点击头像显示活动参与者的昵称。
        - 如果是活动发起人点击，弹出一个新页面，可以查看每个参与者的打卡地点和范围。
        - 只有指定的活动参与者才能点击"参与"按钮。

    3. **参与**
        - 点击"参与"按钮，弹出参与页面。
        - 自己需要设置自己的打卡地点和范围。
        - 如果活动需要保证金，用户需先上交保证金，然后点击"参与"按钮完成参与。

    4. **打卡详情**
        - 点击打卡列表中的活动信息，如果状态为待打卡，跳转至打卡详情页面。
        - 显示活动名称、活动信息、活动时间、活动参与人数、已打卡人数及头像、未打卡人数及头像、是否需要人脸识别、是否需要拍照。
        - 提供一个"打卡"按钮。

    5. **打卡**
        - 点击"打卡"按钮，弹出打卡页面。
        - 检测打卡人是否在打卡范围内。
        - 如果需要人脸识别，提供一个人脸识别按钮。
        - 如果需要拍照，提供一个上传照片的选项。
        - 填写完毕后点击"打卡"按钮完成打卡。
        - 超过活动时间无法打卡。

    6. **底层显示**
        - 打卡列表
        - 打卡记录
        - 个人中心

## 三. 功能扩展
    1. **通知提醒**
        - 在活动开始前，系统自动发送通知提醒用户打卡。
        - 如果用户未在规定时间内打卡，系统发送提醒并扣除押金。

    2. **押金管理**
        - 用户可以在个人中心查看押金余额和押金记录。
        - 押金扣除后，系统自动将押金均分给其他打卡的参与者。

    3. **活动统计**
        - 在个人中心提供活动统计功能，显示用户参与的活动次数、打卡次数、未打卡次数等。

    4. **反馈与支持**
        - 提供用户反馈渠道，用户可以在个人中心提交问题或建议。
        - 提供常见问题解答，帮助用户快速解决问题。

## 四. 技术实现
    1. **前端**
        - 使用微信小程序框架进行开发，确保良好的用户体验。
        - 使用微信提供的API实现人脸识别、拍照、定位等功能。

    2. **后端**
        - 后端使用SpringBoot框架，已有框架，无需额外处理。

    3. **安全与隐私**
        - 确保用户数据的安全性和隐私性，采用加密技术保护用户信息。
        - 遵守微信小程序的相关政策和规定，确保应用的合规性。

## 五. 后端功能需求

### 1. 用户管理
   - **用户认证与授权**：实现微信登录接口，获取用户基本信息
   - **用户信息存储**：存储用户微信OpenID、昵称、头像等基本信息
   - **用户权限管理**：区分普通用户和活动发起人权限

### 2. 活动管理
   - **活动创建**：提供接口允许用户创建打卡活动，设置活动名称、描述、时间、地点等
   - **活动编辑**：允许活动发起人修改活动信息
   - **活动查询**：按时间、状态查询活动列表
   - **活动详情**：获取单个活动的详细信息
   - **活动参与者管理**：添加、移除活动参与者
   - **活动状态管理**：管理活动的预约中、待打卡、已结束等状态

### 3. 预约系统
   - **预约接口**：允许用户预约参与活动
   - **预约时间控制**：管理预约开始和结束时间
   - **预约资格验证**：验证用户是否在指定参与者名单内
   - **自定义打卡地点**：允许用户设置个人打卡地点和范围

### 4. 打卡系统
   - **打卡接口**：提供用户打卡功能
   - **位置验证**：验证用户是否在指定的打卡范围内
   - **人脸识别接口**：接入微信人脸识别API，验证用户身份
   - **照片上传与存储**：处理用户上传的打卡照片
   - **打卡时间控制**：验证打卡是否在有效时间内
   - **打卡统计**：统计活动的打卡人数和未打卡人数

### 5. 押金管理
   - **押金充值**：对接微信支付，实现押金充值功能
   - **押金扣除**：对未按时打卡的用户自动扣除押金
   - **押金分配**：自动将扣除的押金均分给已打卡的参与者
   - **押金余额查询**：查询用户的押金余额
   - **押金记录**：保存用户的押金充值、扣除、获得的记录

### 6. 通知系统
   - **活动提醒**：在活动开始前自动发送提醒消息
   - **打卡提醒**：针对未打卡用户发送提醒
   - **结果通知**：活动结束后通知用户打卡结果和押金情况
   - **系统通知**：发送系统更新、维护等通知

### 7. 数据统计与分析
   - **用户活动统计**：统计用户参与的活动次数、打卡次数等
   - **活动统计**：统计活动的参与率、打卡率等数据
   - **数据导出**：支持数据导出功能，方便管理员分析

### 8. 安全与日志
   - **数据加密**：对敏感信息进行加密存储
   - **接口安全**：实现接口签名验证，防止非法请求
   - **操作日志**：记录用户的关键操作，便于追踪问题
   - **异常处理**：完善的异常处理机制，提供友好的错误提示

### 9. 系统配置
   - **参数配置**：系统关键参数的配置接口
   - **定时任务**：设置定时任务，处理打卡超时、押金分配等操作

### 10. 基础设施
   - **数据库设计**：设计合理的数据库结构
   - **接口文档**：提供完整的API接口文档
   - **性能优化**：针对高并发场景进行优化
   - **监控告警**：系统运行状态监控和异常告警
    
## 六. 后端功能模块详细描述

### 1. 用户管理模块
**作用**：管理微信小程序用户的登录和信息存储，是整个系统的基础模块。
**功能描述**：
- 微信登录集成：通过微信开放平台接口实现用户登录，获取用户的OpenID作为唯一标识
- 用户信息存储：保存用户的微信昵称、头像URL、性别等基本信息
- 用户状态管理：记录用户的在线状态、最后登录时间等信息
- 用户账户关联：将用户微信账号与系统内账户关联，便于用户管理

### 2. 活动管理模块
**作用**：提供活动全生命周期的管理功能，是系统的核心业务模块。
**功能描述**：
- 活动创建：用户可创建打卡活动，设置活动基本信息（名称、描述、时间、地点等）
- 活动配置：设置活动是否需要人脸识别、照片上传、保证金等特殊要求
- 活动编辑：活动发起人可修改活动信息（仅限未开始的活动）
- 活动查询：按时间、状态、参与情况等条件查询活动列表
- 活动详情：获取单个活动的详细信息，包括参与人数、打卡情况等
- 活动参与者管理：指定活动参与者名单，添加或移除参与者
- 活动状态自动更新：根据时间自动更新活动状态（预约中、待打卡、已结束）

### 3. 预约系统模块
**作用**：管理用户对活动的预约流程，确保活动参与的有序进行。
**功能描述**：
- 预约管理：开启/关闭活动预约，设置预约时间范围
- 预约资格控制：验证用户是否在活动指定的参与者名单中
- 预约操作：允许符合条件的用户预约参与活动
- 打卡地点设置：参与者可在预约时设置个人的打卡地点和有效范围
- 保证金缴纳：对需要保证金的活动，处理用户的保证金缴纳
- 预约状态查询：查询用户的预约状态和预约历史

### 4. 打卡系统模块
**作用**：提供活动打卡的核心功能，验证用户是否按要求完成打卡。
**功能描述**：
- 打卡操作：提供用户活动打卡接口，记录打卡时间和位置
- 位置验证：通过GPS定位，验证用户是否在预设的打卡范围内
- 人脸识别：对要求人脸识别的活动，集成微信人脸识别API进行身份验证
- 照片上传：对要求拍照的活动，处理用户上传的照片并存储
- 打卡时间控制：根据活动设置的时间范围，控制打卡的有效期
- 打卡结果统计：实时统计活动的打卡人数和未打卡人数
- 打卡记录查询：提供用户打卡历史记录查询

### 5. 押金管理模块
**作用**：管理用户押金的充值、扣除和分配，确保活动参与的积极性。
**功能描述**：
- 押金设置：活动创建时设置是否需要押金及押金金额
- 押金充值：集成微信支付，实现用户押金充值
- 押金冻结：预约活动时冻结相应金额的押金
- 押金扣除：对未按时打卡的用户自动扣除押金
- 押金分配：将扣除的押金按规则自动均分给已打卡的参与者
- 押金账户管理：管理用户的押金余额、冻结金额和可用金额
- 押金流水记录：详细记录用户押金的每一笔收支变动

### 6. 通知系统模块
**作用**：提供各类消息通知功能，确保用户及时获取活动相关信息。
**功能描述**：
- 活动开始提醒：在活动开始前自动向参与者发送提醒消息
- 打卡提醒：向未打卡的用户发送打卡提醒
- 押金变动通知：当用户押金发生变化时，发送通知说明原因
- 活动状态更新通知：当活动状态变更时通知相关用户
- 系统公告：发布系统更新、维护等全局通知
- 消息中心：集中展示用户收到的所有通知消息

### 7. 数据统计模块
**作用**：提供数据统计和分析功能，帮助用户了解自己的活动参与情况。
**功能描述**：
- 个人活动统计：统计用户参与的活动总数、打卡次数、未打卡次数等
- 押金收支统计：统计用户的押金充值总额、扣除总额、获得总额等
- 活动数据分析：分析活动的参与率、打卡率等关键指标
- 趋势分析：分析用户活动参与频率、打卡率等数据的变化趋势
- 数据导出：支持将统计数据导出为Excel等格式

## 七. 数据库设计

### 客户表(tb_customer)
| 字段名 | 类型 | 长度 | 允许空 | 主键 | 描述 |
| --- | --- | --- | --- | --- | --- |
| id | bigint | 20 | 否 | 是 | 客户ID，自增主键 |
| open_id | varchar | 64 | 否 | 否 | 微信OpenID，唯一 |
| nickname | varchar | 50 | 是 | 否 | 客户昵称 |
| avatar_url | varchar | 255 | 是 | 否 | 客户头像URL |
| gender | tinyint | 1 | 是 | 否 | 性别(0未知,1男,2女) |
| balance | decimal | (10,2) | 否 | 否 | 押金余额 |
| frozen_balance | decimal | (10,2) | 否 | 否 | 冻结押金 |
| last_login_time | datetime | - | 是 | 否 | 最后登录时间 |
| create_time | datetime | - | 否 | 否 | 创建时间 |
| update_time | datetime | - | 否 | 否 | 更新时间 |

### 活动表(tb_activity)
| 字段名 | 类型 | 长度 | 允许空 | 主键 | 描述 |
| --- | --- | --- | --- | --- | --- |
| id | bigint | 20 | 否 | 是 | 活动ID，自增主键 |
| creator_id | bigint | 20 | 否 | 否 | 创建者客户ID |
| title | varchar | 100 | 否 | 否 | 活动名称 |
| description | text | - | 是 | 否 | 活动描述 |
| activity_time | datetime | - | 否 | 否 | 活动时间 |
| activity_location | varchar | 255 | 否 | 否 | 活动地点 |
| need_face_recognition | tinyint | 1 | 否 | 否 | 是否需要人脸识别(0否,1是) |
| need_photo | tinyint | 1 | 否 | 否 | 是否需要拍照(0否,1是) |
| need_deposit | tinyint | 1 | 否 | 否 | 是否需要保证金(0否,1是) |
| deposit_amount | decimal | (10,2) | 是 | 否 | 保证金金额 |
| reservation_start_time | datetime | - | 是 | 否 | 预约开始时间 |
| reservation_end_time | datetime | - | 是 | 否 | 预约结束时间 |
| checkin_start_time | datetime | - | 是 | 否 | 打卡开始时间 |
| checkin_end_time | datetime | - | 是 | 否 | 打卡结束时间 |
| status | tinyint | 1 | 否 | 否 | 活动状态(1预约中,2待打卡,3已结束) |
| participant_count | int | 11 | 否 | 否 | 参与人数 |
| checkin_count | int | 11 | 否 | 否 | 已打卡人数 |
| create_time | datetime | - | 否 | 否 | 创建时间 |
| update_time | datetime | - | 否 | 否 | 更新时间 |

### 活动参与者表(tb_participant)
| 字段名 | 类型 | 长度 | 允许空 | 主键 | 描述 |
| --- | --- | --- | --- | --- | --- |
| id | bigint | 20 | 否 | 是 | 自增主键 |
| activity_id | bigint | 20 | 否 | 否 | 活动ID |
| customer_id | bigint | 20 | 否 | 否 | 客户ID |
| latitude | decimal | (10,6) | 是 | 否 | 打卡地点纬度 |
| longitude | decimal | (10,6) | 是 | 否 | 打卡地点经度 |
| range | int | 11 | 是 | 否 | 打卡范围(米) |
| status | tinyint | 1 | 否 | 否 | 状态(1已指定,2已预约,3已打卡,4未打卡) |
| deposit_paid | tinyint | 1 | 否 | 否 | 是否已缴纳保证金(0否,1是) |
| frozen_amount | decimal | (10,2) | 是 | 否 | 冻结金额 |
| create_time | datetime | - | 否 | 否 | 创建时间 |
| update_time | datetime | - | 否 | 否 | 更新时间 |

### 打卡记录表(tb_checkin)
| 字段名 | 类型 | 长度 | 允许空 | 主键 | 描述 |
| --- | --- | --- | --- | --- | --- |
| id | bigint | 20 | 否 | 是 | 自增主键 |
| activity_id | bigint | 20 | 否 | 否 | 活动ID |
| customer_id | bigint | 20 | 否 | 否 | 客户ID |
| checkin_time | datetime | - | 否 | 否 | 打卡时间 |
| checkin_latitude | decimal | (10,6) | 是 | 否 | 打卡纬度 |
| checkin_longitude | decimal | (10,6) | 是 | 否 | 打卡经度 |
| is_in_range | tinyint | 1 | 否 | 否 | 是否在范围内(0否,1是) |
| face_verified | tinyint | 1 | 是 | 否 | 人脸是否验证(0否,1是) |
| photo_url | varchar | 255 | 是 | 否 | 打卡照片URL |
| status | tinyint | 1 | 否 | 否 | 打卡状态(1成功,2失败) |
| create_time | datetime | - | 否 | 否 | 创建时间 |

### 押金记录表(tb_deposit_record)
| 字段名 | 类型 | 长度 | 允许空 | 主键 | 描述 |
| --- | --- | --- | --- | --- | --- |
| id | bigint | 20 | 否 | 是 | 自增主键 |
| customer_id | bigint | 20 | 否 | 否 | 客户ID |
| activity_id | bigint | 20 | 是 | 否 | 关联活动ID |
| type | tinyint | 1 | 否 | 否 | 类型(1充值,2冻结,3解冻,4扣除,5获得) |
| amount | decimal | (10,2) | 否 | 否 | 金额 |
| balance | decimal | (10,2) | 否 | 否 | 操作后余额 |
| description | varchar | 255 | 是 | 否 | 说明 |
| transaction_id | varchar | 64 | 是 | 否 | 支付交易ID |
| create_time | datetime | - | 否 | 否 | 创建时间 |

### 消息通知表(tb_notification)
| 字段名 | 类型 | 长度 | 允许空 | 主键 | 描述 |
| --- | --- | --- | --- | --- | --- |
| id | bigint | 20 | 否 | 是 | 自增主键 |
| customer_id | bigint | 20 | 否 | 否 | 接收客户ID |
| activity_id | bigint | 20 | 是 | 否 | 关联活动ID |
| type | tinyint | 1 | 否 | 否 | 通知类型(1活动提醒,2打卡提醒,3押金变动,4活动更新,5系统公告) |
| title | varchar | 100 | 否 | 否 | 通知标题 |
| content | text | - | 否 | 否 | 通知内容 |
| is_read | tinyint | 1 | 否 | 否 | 是否已读(0未读,1已读) |
| create_time | datetime | - | 否 | 否 | 创建时间 |

### 系统配置表(tb_config)
| 字段名 | 类型 | 长度 | 允许空 | 主键 | 描述 |
| --- | --- | --- | --- | --- | --- |
| id | bigint | 20 | 否 | 是 | 自增主键 |
| config_key | varchar | 50 | 否 | 否 | 配置键 |
| config_value | varchar | 255 | 否 | 否 | 配置值 |
| description | varchar | 255 | 是 | 否 | 配置描述 |
| create_time | datetime | - | 否 | 否 | 创建时间 |
| update_time | datetime | - | 否 | 否 | 更新时间 |

### 数据库表关系
1. 客户表(tb_customer)与活动表(tb_activity)：一对多关系，一个客户可以创建多个活动
2. 活动表(tb_activity)与活动参与者表(tb_participant)：一对多关系，一个活动可以有多个参与者
3. 客户表(tb_customer)与活动参与者表(tb_participant)：一对多关系，一个客户可以参与多个活动
4. 活动表(tb_activity)与打卡记录表(tb_checkin)：一对多关系，一个活动可以有多个打卡记录
5. 客户表(tb_customer)与打卡记录表(tb_checkin)：一对多关系，一个客户可以有多个打卡记录
6. 客户表(tb_customer)与押金记录表(tb_deposit_record)：一对多关系，一个客户可以有多个押金记录
7. 客户表(tb_customer)与消息通知表(tb_notification)：一对多关系，一个客户可以有多个消息通知
    